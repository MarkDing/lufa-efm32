<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Lufa-efm32 : LUFA port to Silabs EFM32 platform" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Lufa-efm32</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/MarkDing/lufa-efm32">View on GitHub</a>

          <h1 id="project_title">Lufa-efm32</h1>
          <h2 id="project_tagline">LUFA port to Silabs EFM32 platform</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/MarkDing/lufa-efm32/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/MarkDing/lufa-efm32/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a name="implementing-usb-communication-device-class-cdc-on-efm32gg-mcus" class="anchor" href="#implementing-usb-communication-device-class-cdc-on-efm32gg-mcus"><span class="octicon octicon-link"></span></a>Implementing USB communication device class (CDC) on EFM32GG MCUs</h1>

<h2>
<a name="1-introduction" class="anchor" href="#1-introduction"><span class="octicon octicon-link"></span></a>1. Introduction</h2>

<p>USB revolutionized the PC peripheral space by making a very simple plug-and-play interface for users. As a result, many modern computers no longer support RS-232 serial COM ports, opting for the slimmer USB alternative. This can be an issue for the developer who needs a COM port for communication between a peripheral and host PC. A subset of the USB Communication DeviceClass (CDC) can be used to emulate a serial port providing a virtual COM port UART interface. This allows developers to use legacy applications with new products using the same COM port interface as before, with few hardware and software modifications.</p>

<p><img alt="USB CDC Intro" title="USB CDC Virtual COM POrt system"></p>

<p><strong>Figure 1 USB CDC Virtual COM Port System</strong></p>

<p>This application note describes the USB communications device class driver (or USB CDC) in detail and includes an implementation example for the Silicon Labs EFM32 Giant Gecko MCU.</p>

<h3>
<a name="11-assumptions" class="anchor" href="#11-assumptions"><span class="octicon octicon-link"></span></a>1.1. Assumptions</h3>

<p>This document assumes the following:</p>

<ul>
<li>A working knowledge of the C programming language.</li>
<li>Familiarity with the USB 2.0 specification and terms and abbreviations defined by the USB specification.</li>
<li>Familiarity with Silicon Labs EFM32GG development environment.</li>
</ul><h3>
<a name="12-features-and-limitations" class="anchor" href="#12-features-and-limitations"><span class="octicon octicon-link"></span></a>1.2. Features and Limitations</h3>

<p>The CDC firmware implemented with this application note includes the following features:</p>

<ul>
<li>Emulates a serial COM port on PC that supports the CDC Abstract Control Model (ACM).</li>
<li>Provides an abstract communication interface for data transfers between the host and the device.</li>
<li>Handles standard Chapter 9 USB device requests.</li>
<li>Handles CDC-specific requests from USB host.</li>
<li>Notifies the USB host of status using an interrupt endpoint.</li>
<li>Provides data communication with the USB host using a bulk endpoint.</li>
<li>The following baud rates are supported: 600, 1200, 2400, 4800, 9600, 14400, 19200, 38400, 57600, 76800, 115200 and 230400 bps.</li>
</ul><p>The example does not implement the following:</p>

<ul>
<li>No CTS/RTS control is performed, so flow control must be set to nonein the terminal program.</li>
<li>RTS/DTR control is not implemented.</li>
</ul><h2>
<a name="2-relevant-documentation" class="anchor" href="#2-relevant-documentation"><span class="octicon octicon-link"></span></a>2. Relevant Documentation</h2>

<p>EFM32 Giant Gecko Application Notes are listed on the following website: <a href="http://www.silabs.com/32bit-appnotes">www.silabs.com/32bit-appnotes</a>.</p>

<ul>
<li>
<strong>AN758 IMPLEMENTING USB COMMUNICATION DEVICE CLASS (CDC) ON SiM3U1XX MCUs</strong> -- provides an implementation example on porting LUFA USB CDC on SiM3U1xx MCUs.</li>
<li>
<strong>AN0822 SIMPLICITY STUDIO USERâ€™S GUIDE</strong> -- provides a description of the Simplicity Studio IDE features and environment.</li>
<li>
<strong>AN0065 EFM32 as USB Device</strong> -- provides a description of the EFM32 USB Device stack.</li>
</ul><h2>
<a name="3-usb-cdc-class" class="anchor" href="#3-usb-cdc-class"><span class="octicon octicon-link"></span></a>3. USB CDC Class</h2>

<p>The USB communications device class (CDC) is a composite USB device class, and the class may include more than one interface. The CDC is used primarily for modems, but also for ISDN, fax machines, and telephony applications for performing regular voice calls.
The Abstract Control Model subclass of CDC and bridges the gap between legacy modem devices and USB devices, enabling the use of application programs designed for older modems.</p>

<h3>
<a name="31-class-requests" class="anchor" href="#31-class-requests"><span class="octicon octicon-link"></span></a>3.1. Class Requests</h3>

<p>The class requests and class notifications supported are listed in Table 1.</p>

<p><strong>Table 1. Abstract Control Model Requests</strong></p>

<table>
<thead><tr>
<th>Request</th>
<th>Code</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr>
<td>SET_LINE_CODING</td>
<td>20h</td>
<td>Configures baud rate, stop-bits, parity, and numberof-character bits.</td>
</tr>
<tr>
<td>GET_LINE_CODING</td>
<td>21h</td>
<td>Requests current DTE rate, stop-bits, parity, and number-of-character bits.</td>
</tr>
<tr>
<td>SET_CONTROL_LINE_STATE</td>
<td>22h</td>
<td>RS232 signalused to tell the DCE device the DTE device is now present.</td>
</tr>
</tbody>
</table><p>These class-specific requests are used for device and call management.</p>

<h3>
<a name="311-set-line-coding" class="anchor" href="#311-set-line-coding"><span class="octicon octicon-link"></span></a>3.1.1. Set Line Coding</h3>

<p>This request allows the host to specify typical asynchronous line-character formatting properties.</p>

<table>
<thead><tr>
<th>bmRequestType</th>
<th>bRequest</th>
<th>wValue</th>
<th>wIndex</th>
<th>wLength</th>
<th>Data</th>
</tr></thead>
<tbody><tr>
<td>00100001b</td>
<td>SET_LINE_CODING</td>
<td>0</td>
<td>interface</td>
<td>size of structure</td>
<td>line coding structure</td>
</tr></tbody>
</table><p>Table 2 defines the line coding properties.</p>

<p><strong>Table 2. Line Coding Format</strong></p>

<table>
<thead><tr>
<th>Offset</th>
<th>Field</th>
<th>Size</th>
<th>Value</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr>
<td>0</td>
<td>dwDTERate</td>
<td>4</td>
<td>Number</td>
<td>Data terminal rate, in bits per second.</td>
</tr>
<tr>
<td>4</td>
<td>bCharFormat</td>
<td>1</td>
<td>Number</td>
<td>0: 1 Stop bit <br> 1: 1.5 Stop bits <br> 2: 2 Stop bits</td>
</tr>
<tr>
<td>5</td>
<td>bParityType</td>
<td>1</td>
<td>Number</td>
<td>Parity: <br> 0:None <br> 1: Odd <br> 2: Even <br> 3: Mark <br> 4: Space</td>
</tr>
<tr>
<td>6</td>
<td>bDataBits</td>
<td>1</td>
<td>Number</td>
<td>Data bits (5, 6, 7, 8 or 16).</td>
</tr>
</tbody>
</table><h3>
<a name="312-get-line-coding" class="anchor" href="#312-get-line-coding"><span class="octicon octicon-link"></span></a>3.1.2. Get Line Coding</h3>

<p>This request allows the host to find out the currently configured line coding. Table 2 defines the line coding properties.</p>

<table>
<thead><tr>
<th>bmRequestType</th>
<th>bRequest</th>
<th>wValue</th>
<th>wIndex</th>
<th>wLength</th>
<th>Data</th>
</tr></thead>
<tbody><tr>
<td>10100001b</td>
<td>GET_LINE_CODING</td>
<td>0</td>
<td>interface</td>
<td>size of structure</td>
<td>line coding structure</td>
</tr></tbody>
</table><h3>
<a name="313-set-control-line-state" class="anchor" href="#313-set-control-line-state"><span class="octicon octicon-link"></span></a>3.1.3. Set Control Line State</h3>

<p>This request generates RS-232/V.24 style control signals. Table 3 defines control signal bitmap.</p>

<table>
<thead><tr>
<th>bmRequestType</th>
<th>bRequest</th>
<th>wValue</th>
<th>wIndex</th>
<th>wLength</th>
<th>Data</th>
</tr></thead>
<tbody><tr>
<td>00100001b</td>
<td>SET_LINE_CONTROL_STATE</td>
<td>control signal bitmap</td>
<td>interface</td>
<td>0</td>
<td>none</td>
</tr></tbody>
</table><p><strong>Table 3. Control Signal Bitmap</strong></p>

<table>
<thead><tr>
<th>Bit Position</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr>
<td>15:2</td>
<td>Reserved (Reset to zero).</td>
</tr>
<tr>
<td>1</td>
<td>Carrier control for half duplex modems. This signal corresponds to V.24 signal 105 and RS232 signal RTS. <br> 0: Deactivate carrier. <br> 1: Activate carrier. <br>The device ignores the value of this bit when operating in full duplex mode.</td>
</tr>
<tr>
<td>0</td>
<td>Indicates to DCE if DTE is present or not.This signal corresponds to V.24 signal 108/2 and RS232 signal DTR. <br> 0: DTE is not present. <br> 1: DTE is present</td>
</tr>
</tbody>
</table><h3>
<a name="32-class-notifictions" class="anchor" href="#32-class-notifictions"><span class="octicon octicon-link"></span></a>3.2. Class Notifictions</h3>

<p>Table 4 shows the class notifications supported by the Abstract Control Model.</p>

<p><strong>Table 4. Abstract Control Model Notifications</strong></p>

<table>
<thead><tr>
<th>Notification</th>
<th>Code</th>
<th>Description</th>
</tr></thead>
<tbody><tr>
<td>SERIAL_STATE</td>
<td>20h</td>
<td>Returns the current state of the carrier detects, DSR, break, and ring signal.</td>
</tr></tbody>
</table><h3>
<a name="serial-state" class="anchor" href="#serial-state"><span class="octicon octicon-link"></span></a>Serial State</h3>

<p>This notification sends an asynchronous message containing the current UART status.</p>

<table>
<thead><tr>
<th>bmRequestType</th>
<th>bRequest</th>
<th>wValue</th>
<th>wIndex</th>
<th>wLength</th>
<th>Data</th>
</tr></thead>
<tbody><tr>
<td>10100001b</td>
<td>SERIAL_STATE</td>
<td>0</td>
<td>interface</td>
<td>2</td>
<td>UART state bitmap</td>
</tr></tbody>
</table><p>The data field for this notification is a bitmapped value that contains the current state of detects transmission
carrier, break, ring signal, and device overrun error. These signals are typically found on a UART and are used for
communication status reporting. A state is considered enabled if its respective bit is set to 1.</p>

<p><strong>Note</strong>: The firmware example included with this application does not currently support state change</p>

<p><strong>Table 5. UART State Bitmap</strong></p>

<table>
<thead><tr>
<th>Bit Position</th>
<th>Field</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr>
<td>15:7</td>
<td></td>
<td>Reserved (future use).</td>
</tr>
<tr>
<td>6</td>
<td>bOverRun</td>
<td>Received data has been discarded due to overrun in the device.</td>
</tr>
<tr>
<td>5</td>
<td>bParity</td>
<td>A parity error occurred.</td>
</tr>
<tr>
<td>4</td>
<td>bFraming</td>
<td>A framing error occurred.</td>
</tr>
<tr>
<td>3</td>
<td>bRingSignal</td>
<td>State of ring signal detection of the device.</td>
</tr>
<tr>
<td>2</td>
<td>bBreak</td>
<td>State of break detection mechanism of the device.</td>
</tr>
<tr>
<td>1</td>
<td>bTxCarrier</td>
<td>State of transmission carrier. This signal corresponds to V.24 signal 106 and RS232 signal DSR.</td>
</tr>
<tr>
<td>0</td>
<td>bRxCarrier</td>
<td>State of receiver carrier detection mechanism of device. This signal corresponds to V.24 signal 109 and RS232 signal DCD</td>
</tr>
</tbody>
</table><h3>
<a name="33-endpoint-configuration" class="anchor" href="#33-endpoint-configuration"><span class="octicon octicon-link"></span></a>3.3. Endpoint Configuration</h3>

<p>Table 6 illustrates the endpoint configuration for the Abstract Control Model.</p>

<p><strong>Table 6. UART State Bitmap</strong></p>

<table>
<thead><tr>
<th>Endpoint</th>
<th>Direction</th>
<th>Type</th>
<th>Max Packet Size</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr>
<td>EP0</td>
<td>In/Out</td>
<td>Control</td>
<td>64</td>
<td>Standard requests, class requests.</td>
</tr>
<tr>
<td>EP1</td>
<td>In</td>
<td>Interrupt</td>
<td>16</td>
<td>State notification from device to host.</td>
</tr>
<tr>
<td>EP2</td>
<td>In</td>
<td>Bulk</td>
<td>64</td>
<td>Data transferfrom device to host.</td>
</tr>
<tr>
<td>EP3</td>
<td>Out</td>
<td>Bulk</td>
<td>64</td>
<td>Data transfer from host to device.</td>
</tr>
</tbody>
</table><p>Figure 2 shows a standard CDC communication flow.</p>

<p><img alt="CDC USB LOG" title="CDC USB log"></p>

<p><strong>Figure 2. USB CDC Communication FLow</strong></p>

<h2>
<a name="4-lufa-usb-stack" class="anchor" href="#4-lufa-usb-stack"><span class="octicon octicon-link"></span></a>4. LUFA USB Stack</h2>

<p>The USB CDC firmware example is based on the <code>LUFA</code> open-source project. <code>LUFA</code> is an open-source complete USB stack released under the permissive MIT License. It includes support for many USB classes, both for USB Hosts and USB Devices. For USB Devices, the <code>LUFA</code> stack includes support for Audio Class, CDC Class, HID Class, Mass Storage Class, MIDI Class, and RNDIS Class.
More information about the <code>LUFA</code> project can be found on the official website: <a href="http://www.fourwalledcubicle.com/LUFA.php">http://www.fourwalledcubicle.com/LUFA.php</a></p>

<ul>
<li>The USB CDC project contains a prebuilt LUFA USB stack documentation which locate at .\LUFA\Documentation\html. Double click on the index.html, the documentations shows in your default browser.</li>
</ul><p><img alt="LUFA documentation" title="LUFA USB documentation"></p>

<p><strong>Figure 3. USB LUFA Libary Documentation</strong></p>

<ul>
<li>This implementation support two boards of EFM32GG, STK3700 and DK3750. Default setting is DK3750, To change board selection, just modify macro definition in .\LUFA\Common\BoardTypes.h. </li>
</ul><div class="highlight highlight-c"><pre><span class="cp">#if !defined(__DOXYGEN__)</span>
<span class="cp">    #define BOARD_                 BOARD_DK3750</span>
<span class="cp">    #if !defined(BOARD)</span>
<span class="cp">        #define BOARD              BOARD_DK3750</span>
<span class="cp">    #endif</span>
<span class="cp">#endif</span>
</pre></div>

<p>For STK3700 board, there is no UART socket on board. UART signals are connected to EXP Header. </p>

<p><img alt="USART on EXP" title="USART signals on STK3700 Expansion Header"></p>

<p><strong>Figure 4. USART signals on STK3700 Expansion Header</strong></p>

<h2>
<a name="5-usb-cdc-driver" class="anchor" href="#5-usb-cdc-driver"><span class="octicon octicon-link"></span></a>5. USB CDC Driver</h2>

<p>The CDC class is implemented in all releases of Windows, and the operatingsystem needs an INF file for the CDC driver. This INF file contains the Vendor ID and Product ID. If the VID/PID of the USB devices matches the INF file, Windows will load the driver described in the file. The <strong>VirtualSerial.inf</strong> file can be found in the <strong>.\Demos\Device\LowLevel\EFM32Demos\VCP</strong> directory. </p>

<h3>
<a name="installing-the-driver" class="anchor" href="#installing-the-driver"><span class="octicon octicon-link"></span></a>Installing the Driver</h3>

<p>To install the driver on Windows 7:</p>

<ol>
<li>Build the project and download firmware to the EFM32GG DK3750 board.</li>
<li>Connect the USB cable between the Device MCU plugin board USB connector  and the PC.</li>
<li>Open Device Manager. The device will appear under <strong>Other devices</strong> as the <strong>EFM32GG CDC Device</strong>.
<img alt="Device Manager">
</li>
<li>Right-click on the <strong>EFM32GG CDC Device</strong> and select <strong>Update Driver Software</strong>.
<img alt="Device Manager Update">
</li>
<li>Select <strong>Browse my computer for driver software</strong>.
<img alt="Updata Driver Software">
</li>
<li>Select <strong>Browse my computer for driver software</strong>.
<img alt="Browse Driver Software">
</li>
<li>Windows will display a warning. Select <strong>Install this driversoftware anyway</strong>.
<img alt="Windows Sercurity">
</li>
<li>When the driver finishes installing,Windows will report the installation results.</li>
<li>Open Device Manager and observethe device. It will now appear under <strong>Ports (COM &amp; LPT)</strong> with an assigned COM port number.
<img alt="Device Manager Done">
</li>
</ol><h2>
<a name="contact-information" class="anchor" href="#contact-information"><span class="octicon octicon-link"></span></a>CONTACT INFORMATION</h2>

<p><strong>Silicon Laboratories Inc.</strong> 
400 West Cesar Chavez
Austin, TX 78701
Tel: 1+(512) 416-8500
Fax: 1+(512) 416-9669
Toll Free: 1+(877) 444-3032
Please visit the Silicon Labs Technical Support web page:
<a href="https://www.silabs.com/support/pages/contacttechnicalsupport.aspx">https://www.silabs.com/support/pages/contacttechnicalsupport.aspx</a>
and register to submit a technical support request.</p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Lufa-efm32 maintained by <a href="https://github.com/MarkDing">MarkDing</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
